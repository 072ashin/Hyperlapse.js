Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.toDeg=function(){return this*180/Math.PI};Array.prototype.remove=function(e,t){var n=this.slice((t||e)+1||this.length);this.length=e<0?this.length+e:e;return this.push.apply(this,n)};var pointOnLine=function(e,t,n){var r=t.lat().toRad(),i=t.lng().toRad();var s=n.lat().toRad(),o=n.lng().toRad();x=r+e*(s-r);y=i+e*(o-i);return new google.maps.LatLng(x.toDeg(),y.toDeg())};var HyperlapsePoint=function(e,t,n,r,i,s){var o=this;this.location=e;this.pano_id=t;this.heading=n||0;this.pitch=r||0;this.elevation=i||0;this.image=s||null};var Hyperlapse=function(e,t,n){"use strict";var r=this,i=[],s=e,o=t,u=n||{},a=u.width||800,f=u.height||400,l=20,c=u.distance_between_points||20,h=u.max_points||100,p=u.fov||70,d=u.zoom||1,v=0,m=0,g=0,y=0,b=false,w=false,E=0,S=0,x=0,T=true,N=0,C=0,k,L,A,O,M,_,D,P=false,H=u.image||null,B=Date.now(),j=0,F=0,I=null,q=[],R=[];var U=function(e){if(r.onError)r.onError(e)};var z=function(e){if(r.onFrame)r.onFrame(e)};var W=function(e){if(r.onPlay)r.onPlay(e)};var X=function(e){if(r.onPause)r.onPause(e)};var V=new google.maps.DirectionsService;var $=new google.maps.ElevationService;var J=new google.maps.StreetViewService;k=document.createElement("canvas");L=k.getContext("2d");A=new THREE.PerspectiveCamera(p,a/f,1,1100);A.target=new THREE.Vector3(0,0,0);O=new THREE.Scene;O.add(A);try{var K=!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(Q){console.log(Q)}M=new THREE.WebGLRenderer({preserveDrawingBuffer:true});M.autoClearColor=false;M.setSize(a,f);_=new THREE.Mesh(new THREE.SphereGeometry(500,60,40),new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture("blank.jpg")}));_.doubleSided=true;O.add(_);s.appendChild(M.domElement);D=new GSVPANO.PanoLoader({zoom:d});D.onError=function(e){U({message:e})};D.onPanoramaLoad=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.setAttribute("width",this.canvas.width);e.setAttribute("height",this.canvas.height);t.drawImage(this.canvas,0,0);R[E].image=e;if(++E!=R.length){G({position:E});if(!P){D.composePanorama(R[E].pano_id)}else{P=false;w=false}}else{Y({})}};var G=function(e){if(r.onLoadProgress)r.onLoadProgress(e)};var Y=function(e){w=false;E=0;r.animate();if(r.onLoadComplete)r.onLoadComplete(e)};var Z=function(e){if(r.onRouteProgress)r.onRouteProgress(e)};var et=function(e){var t=[];for(var n=0;n<R.length;n++){t[n]=R[n].location}nt(t,function(e){for(n=0;n<R.length;n++){R[n].elevation=e[n].elevation}});if(r.onRouteComplete)r.onRouteComplete(e)};var tt=function(e){D.load(q[E],function(){if(D.id!=I){I=D.id;var t=new HyperlapsePoint(D.location,D.id,D.rotation,D.pitch,D.elevation);R.push(t);Z({point:t});if(E==q.length-1){et({response:e,points:R})}else{E++;tt(e)}}else{q.splice(E,1);if(E==q.length){et({response:e,points:R})}else{tt(e)}}})};var nt=function(e,t){var n={locations:e};$.getElevationForLocations(n,function(e,n){if(n==google.maps.ElevationStatus.OK){t(e)}else{t(null)}})};var rt=function(e){if(!b){var t=e.routes[0];var n=t.overview_path;var i=t.legs;var s=0;for(var o=0;o<i.length;++o){s+=i[o].distance.value}var u=s/h;l=u<c?l=c:l=u;var a=0;var f=0;var p,d;for(o=0;o<n.length;o++){if(o+1<n.length){p=n[o];d=n[o+1];a=google.maps.geometry.spherical.computeDistanceBetween(p,d);if(f>0&&f<a){p=pointOnLine(f/a,p,d);a=google.maps.geometry.spherical.computeDistanceBetween(p,d);q.push(p);f=0}else if(f>0&&f>a){f-=a}if(f==0){var v=Math.floor(a/l);if(v>0){for(var m=0;m<v;m++){var g=m/v;if(g!=0||g==0&&o==0){var y=pointOnLine(g,p,d);q.push(y)}}f=a-l*v}else{f=l*(1-a/l)}}}else{q.push(n[o])}}tt(e)}else{r.pause();rt(e)}};var it=function(){_.material.map.image=R[E].image;_.material.map.needsUpdate=true;S=R[E].heading;x=R[E].pitch;N=google.maps.geometry.spherical.computeHeading(R[E].location,r.lookat);var e=R[E].elevation-r.elevation_offset;var t=google.maps.geometry.spherical.computeDistanceBetween(R[E].location,r.lookat);var n=C-e;var i=Math.atan(Math.abs(n)/t).toDeg();if(r.useElevation)y=n<0?-i:i;r.render();z({position:E,point:R[E]})};var st=function(){it();if(T){if(++E==R.length){E=R.length-1;T=!T}}else{if(--E==-1){E=0;T=!T}}};this.start=u.start||null;this.end=u.end||null;this.lookat=u.lookat||null;this.millis=u.millis||50;this.elevation_offset=u.elevation||0;this.tilt=u.tilt||0;this.useElevation=true;this.position={x:0,y:0};this.offset={x:0,y:0,z:0};this.use_lookat=true;this.use_rotation_comp=false;this.rotation_comp=0;this.isPlaying=function(){return b};this.isLoading=function(){return w};this.length=function(){return R.length};this.setPitch=function(e){y=e};this.setDistanceBetweenPoint=function(e){c=e};this.setMaxPoints=function(e){h=e};this.fov=function(){return p};this.webgl=function(){return M};this.getCurrentPano=function(){return R[E].image};this.setLookat=function(e){r.lookat=e;var t=nt([r.lookat],function(e){C=e[0].elevation})};this.setLookat(r.lookat);this.setFOV=function(e){p=Math.floor(e);A.projectionMatrix=THREE.Matrix4.makePerspective(p,a/f,1,1100)};this.setSize=function(e,t){a=e;f=t;M.setSize(a,f);A.projectionMatrix=THREE.Matrix4.makePerspective(p,a/f,1,1100)};this.reset=function(){q.remove(0,-1);R.remove(0,-1);r.elevation_offset=0;r.tilt=0;v=0;m=0;r.position.x=0;r.position.y=0;r.offset.x=0;r.offset.y=0;r.offset.z=0;g=0;y=0;E=0;S=0;x=0;T=true;w=false};this.generate=function(e){if(!w){w=true;r.reset();var e=e||{};c=e.distance_between_points||c;h=e.max_points||h;if(e.route){rt(e.route)}else{if(!r.start==null||!r.end==null){console.log("no start or end point");return}var t={label:"Hyperlapse",request:{origin:r.start,destination:r.end,travelMode:google.maps.DirectionsTravelMode.DRIVING},rendering:{draggable:false}};V.route(t.request,function(e,t){if(t==google.maps.DirectionsStatus.OK){rt(e)}else{console.log(t)}})}}};this.load=function(){E=0;D.composePanorama(R[E].pano_id)};this.cancelLoad=function(){if(w)P=true};this.animate=function(){var e=B;B=Date.now();F+=B-e;if(F>=r.millis){if(b)st();F=0}requestAnimationFrame(r.animate)};this.getCameraPosition=function(){return{lat:v,lon:m}};this.render=function(){if(!w&&r.length()>0){var e=E/r.length();var t=r.position.x+r.offset.x*e;var n=r.position.y+r.offset.y*e;var i=r.tilt+r.offset.z.toRad()*e;var s=r.use_lookat?N-S.toDeg()+t:t;var o=y+n;var u=m,a=v;m=m+(s-u);v=v+(o-a);v=Math.max(-85,Math.min(85,v));var f=(90-v).toRad();var l=m.toRad();A.target.x=500*Math.sin(f)*Math.cos(l);A.target.y=500*Math.cos(f);A.target.z=500*Math.sin(f)*Math.sin(l);A.lookAt(A.target);if(r.use_rotation_comp)A.rotation.z-=r.rotation_comp.toRad();_.rotation.z=x.toRad();M.render(O,A)}};this.play=function(){if(!w)b=true};this.pause=function(){b=false};this.next=function(){r.pause();if(E+1!=R.length){E++;it()}};this.prev=function(){r.pause();if(E-1!=0){E--;it()}}}