<!DOCTYPE html>
<html> 
<head> 
   <meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
   <title>Basic</title> 

   <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script> 
   <script src="js/dat.gui.min.js"></script>
   <script src="js/GSVPano.js"></script>
   <script src="js/Three.js"></script>
   <script src="js/RequestAnimationFrame.js"></script>
   <script src="../src/Hyperlapse.js"></script>
   <script> 
   
      var start_point = new google.maps.LatLng(44.3431,6.783936);
      var end_point = new google.maps.LatLng(44.340578,6.782684);
      var lookat_point = new google.maps.LatLng(44.344875,6.790581);
      var map, directions_renderer;
      var start_pin, end_pin, pivot_pin, camera_pin;

      function init() {

         /* Map */

         var mapOpt = { 
            mapTypeId: google.maps.MapTypeId.SATELLITE,
            center: start_point,
            zoom: 15
         };

         map = new google.maps.Map(document.getElementById("map"), mapOpt);

         directions_renderer = new google.maps.DirectionsRenderer({draggable:false, markerOptions:{visible: false}});
         directions_renderer.setMap(map);
         directions_renderer.setOptions({preserveViewport:true});

         camera_pin = new google.maps.Marker({
            position: start_point,
            map: map
         });

         start_pin = new google.maps.Marker({
            position: start_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (start_pin, 'dragend', function (event) {
            hyperlapse.start = start_pin.getPosition();
         });

         end_pin = new google.maps.Marker({
            position: end_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (end_pin, 'dragend', function (event) {
            hyperlapse.end = end_pin.getPosition();
         });

         pivot_pin = new google.maps.Marker({
            position: lookat_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (pivot_pin, 'dragend', function (event) {
            hyperlapse.setLookat( pivot_pin.getPosition() );
         });



         /* Hyperlapse */

         var hyperlapse = new Hyperlapse(document.getElementById('pano'), map, {
            start: start_point, 
            end: end_point,
            lookat: lookat_point,
            millis: 50,
            width: 854,
            height: 480,
            zoom: 1,
            distance_between_points: 10,
            max_points: 100
         });
         
         hyperlapse.addListener({'onRoute': function(e){
            console.log(e.response);
            directions_renderer.setDirections(e.response);
         }});

         hyperlapse.addListener({'onLoadProgress': function(e){
            document.getElementById("text").innerHTML = "Loading: "+ (e.position+1) +" of "+ hyperlapse.length();
         }});

         hyperlapse.addListener({'onLoadComplete': function(e){
            console.log("load complete");
         }});

         hyperlapse.addListener({'onFrame': function(e){
            camera_pin.setPosition(e.point);
            //console.log(e.point);
            document.getElementById("text").innerHTML = "Position: "+ (e.position+1) +" of "+ hyperlapse.length();
         }});

         directions_renderer.addListener();         


         /* Dat GUI */

         var gui = new dat.GUI();

         var o = {elevation_offset:0, tilt:0, millis:50, lookat:true, elevation:true};

         var parameters = gui.addFolder('parameters');
         var pitch_control = parameters.add(o, 'elevation_offset', -500, 500);
         pitch_control.onChange(function(value) {
            hyperlapse.elevation_offset = value;
         });

         var tilt_control = parameters.add(o, 'tilt', -Math.PI/2, Math.PI/2);
         tilt_control.onChange(function(value) {
            hyperlapse.tilt = value;
         });

         var millis_control = parameters.add(o, 'millis', 10, 250);
         millis_control.onChange(function(value) {
            hyperlapse.millis = value;
         });

         var elevation_control = parameters.add(o, 'elevation');
         elevation_control.onChange(function(value) {
            hyperlapse.useElevation = value;
         });

         var lookat_control = parameters.add(o, 'lookat');
         lookat_control.onChange(function(value) {
            if(value) {
               hyperlapse.enableLookat();
            } else {
               hyperlapse.disableLookat();
            }
         });

         

         var play_controls = gui.addFolder('play controls');
         play_controls.add(hyperlapse, 'play');
         play_controls.add(hyperlapse, 'pause');
         play_controls.add(hyperlapse, 'next');
         play_controls.add(hyperlapse, 'prev');
         play_controls.open();

         gui.add(hyperlapse, 'generate');
      }

      window.onload = init;
   </script> 
</head> 
<body> 
   <div id="pano" ></div>
   <div id="map" style="width: 400px; height: 200px"></div>
   <div id="text"></div>
</body> 
</html>