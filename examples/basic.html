<!DOCTYPE html>
<html> 
<head> 
   <meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
   <title>Basic</title> 

   <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script> 
   <script src="js/dat.gui.min.js"></script>
   <script src="js/GSVPano.js"></script>
   <script src="js/Three.js"></script>
   <script src="js/RequestAnimationFrame.js"></script>
   <script src="../src/Hyperlapse.js"></script>
   <script> 
   
      var start_point = new google.maps.LatLng(44.3431,6.783936);
      var end_point = new google.maps.LatLng(44.340578,6.782684);
      var lookat_point = new google.maps.LatLng(44.344875,6.790581);
      var map, directions_renderer, directions_service, streetview_service;
      var start_pin, end_pin, pivot_pin, camera_pin;

      function init() {

         /* Map */

         function snapToRoad(point, callback) {
            var request = { origin: point, destination: point, travelMode: google.maps.TravelMode["DRIVING"] };
            directions_service.route(request, function(response, status) {
               if(status=="OK") callback(response.routes[0].overview_path[0]);
               else callback(null);
            });
         }

         var mapOpt = { 
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            center: start_point,
            zoom: 15
         };

         map = new google.maps.Map(document.getElementById("map"), mapOpt);

         directions_service = new google.maps.DirectionsService();
         directions_renderer = new google.maps.DirectionsRenderer({draggable:false, markerOptions:{visible: false}});
         directions_renderer.setMap(map);
         directions_renderer.setOptions({preserveViewport:true});

         camera_pin = new google.maps.Marker({
            position: start_point,
            map: map
         });

         start_pin = new google.maps.Marker({
            position: start_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (start_pin, 'dragend', function (event) {
            snapToRoad(start_pin.getPosition(), function(result) {
               start_pin.setPosition(result);
               hyperlapse.start = result;
            });
         });

         end_pin = new google.maps.Marker({
            position: end_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (end_pin, 'dragend', function (event) {
            snapToRoad(end_pin.getPosition(), function(result) {
               end_pin.setPosition(result);
               hyperlapse.end = result;
            });
         });

         pivot_pin = new google.maps.Marker({
            position: lookat_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (pivot_pin, 'dragend', function (event) {
            hyperlapse.setLookat( pivot_pin.getPosition() );
         });



         /* Hyperlapse */

         var hyperlapse = new Hyperlapse(document.getElementById('pano'), map, {
            start: start_point, 
            end: end_point,
            lookat: lookat_point,
            millis: 50,
            width: 854,
            height: 480,
            zoom: 2,
            distance_between_points: 10,
            max_points: 100
         });
         
         hyperlapse.onRoute = function(e) {
            directions_renderer.setDirections(e.response);
            document.getElementById("text").innerHTML = "Number of Points: "+ hyperlapse.length();
         };

         hyperlapse.onLoadProgress = function(e) {
            document.getElementById("text").innerHTML = "Loading: "+ (e.position+1) +" of "+ hyperlapse.length();
         };

         hyperlapse.onError = function(e) {
            document.getElementById("text").innerHTML = "ERROR: "+ e.message;
         };

         hyperlapse.onLoadComplete = function(e) {
            document.getElementById("text").innerHTML = "" +
               "Start: " + start_pin.getPosition().toString() + 
               "<br>End: " + end_pin.getPosition().toString() + 
               "<br>Lookat: " + pivot_pin.getPosition().toString() + 
               "<br>Ready.";
         };

         hyperlapse.onFrame = function(e) {
            camera_pin.setPosition(e.point);
            document.getElementById("text").innerHTML = "" +
               "Start: " + start_pin.getPosition().toString() + 
               "<br>End: " + end_pin.getPosition().toString() + 
               "<br>Lookat: " + pivot_pin.getPosition().toString() + 
               "<br>Position: "+ (e.position+1) +" of "+ hyperlapse.length();
         };

         directions_renderer.addListener();         


         /* Dat GUI */

         var gui = new dat.GUI();

         var o = {distance_between_points:10, max_points:100, fov: 70, elevation_offset:0, tilt:0, millis:50, lookat:true, elevation:true};

         var parameters = gui.addFolder('parameters');

         var distance_between_points_control = parameters.add(o, 'distance_between_points', 5, 100);
         distance_between_points_control.onChange(function(value) {
            hyperlapse.setDistanceBetweenPoint(value);
         });

         var max_points = parameters.add(o, 'max_points', 10, 300);
         max_points.onChange(function(value) {
            hyperlapse.setMaxPoints(value);
         });

         var fov_control = parameters.add(o, 'fov', 1, 180);
         fov_control.onChange(function(value) {
            hyperlapse.setFOV(value);
         });

         var pitch_control = parameters.add(o, 'elevation_offset', -500, 500);
         pitch_control.onChange(function(value) {
            hyperlapse.elevation_offset = value;
         });

         var tilt_control = parameters.add(o, 'tilt', -Math.PI/2, Math.PI/2);
         tilt_control.onChange(function(value) {
            hyperlapse.tilt = value;
         });

         var millis_control = parameters.add(o, 'millis', 10, 250);
         millis_control.onChange(function(value) {
            hyperlapse.millis = value;
         });

         var elevation_control = parameters.add(o, 'elevation');
         elevation_control.onChange(function(value) {
            hyperlapse.useElevation = value;
         });

         var lookat_control = parameters.add(o, 'lookat');
         lookat_control.onChange(function(value) {
            if(value) {
               hyperlapse.enableLookat();
            } else {
               hyperlapse.disableLookat();
            }
         });

         hyperlapse.drop_pins = function(){
            var bounds = map.getBounds();
            var top_left = bounds.getNorthEast();
            var bot_right = bounds.getSouthWest();
            var hdif = Math.abs(top_left.lng() - bot_right.lng());
            var spacing = hdif/4;

            var center = map.getCenter();
            var c1 = new google.maps.LatLng(center.lat(), center.lng()-spacing);
            var c2 = new google.maps.LatLng(center.lat(), center.lng());
            var c3 = new google.maps.LatLng(center.lat(), center.lng()+spacing);


            snapToRoad(c1, function(result) {
               start_pin.setPosition(result);
               hyperlapse.start = result;
            });

            snapToRoad(c3, function(result) {
               end_pin.setPosition(result);
               hyperlapse.end = result;
            });

            pivot_pin.setPosition(c2);
         };

         var play_controls = gui.addFolder('play controls');
         play_controls.add(hyperlapse, 'play');
         play_controls.add(hyperlapse, 'pause');
         play_controls.add(hyperlapse, 'next');
         play_controls.add(hyperlapse, 'prev');
         play_controls.open();

         gui.add(hyperlapse, 'drop_pins');
         gui.add(hyperlapse, 'generate');
         gui.add(hyperlapse, 'load');
      }

      window.onload = init;
   </script> 
</head> 
<body> 
   <div id="pano" ></div>
   <div id="map" style="width: 600px; height: 300px; float: left; padding: 10px;"></div>
   <div id="text" style="width: 600px; height: 300px; float: left; padding: 10px;"></div>
</body> 
</html>