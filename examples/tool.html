<!DOCTYPE html>
<html> 
<head> 
   <meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
   <title>Basic</title> 

   <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script> 
   <script src="js/dat.gui.min.js"></script>
   <script src="../../GSVPano.js/src/GSVPano.js"></script>
   <script src="js/Three.js"></script>
   <script src="js/RequestAnimationFrame.js"></script>
   <script src="../src/Hyperlapse.js"></script>
   <script> 
   
      var start_point = new google.maps.LatLng(44.3431,6.783936);
      var end_point = new google.maps.LatLng(44.340578,6.782684);
      var lookat_point = new google.maps.LatLng(44.344875,6.790581);
      var map, directions_renderer, directions_service, streetview_service, geocoder;
      var start_pin, end_pin, pivot_pin, camera_pin;
      var _elevation = 0;
      var _route_markers = [];

      function show(msg) {
         document.getElementById("text").innerHTML = msg;
      }

      function init() {

         if( window.location.hash ) {
            parts = window.location.hash.substr( 1 ).split( ',' );
            start_point = new google.maps.LatLng(parts[0], parts[1]);
            lookat_point = new google.maps.LatLng(parts[2], parts[3]);
            end_point = new google.maps.LatLng(parts[4], parts[5]);
            _elevation = parts[6] || 0;
         } 

         /* Map */

         function snapToRoad(point, callback) {
            var request = { origin: point, destination: point, travelMode: google.maps.TravelMode["DRIVING"] };
            directions_service.route(request, function(response, status) {
               if(status=="OK") callback(response.routes[0].overview_path[0]);
               else callback(null);
            });
         }

         function changeHash() {
            window.location.hash = start_pin.getPosition().lat() + ',' + start_pin.getPosition().lng() + ','
               + pivot_pin.getPosition().lat() + ',' + pivot_pin.getPosition().lng() + ','
               + end_pin.getPosition().lat() + ',' + end_pin.getPosition().lng() + ','
               + _elevation;
         }

         var mapOpt = { 
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            center: start_point,
            zoom: 15
         };

         map = new google.maps.Map(document.getElementById("map"), mapOpt);
         geocoder = new google.maps.Geocoder();

         directions_service = new google.maps.DirectionsService();
         directions_renderer = new google.maps.DirectionsRenderer({draggable:false, markerOptions:{visible: false}});
         directions_renderer.setMap(map);
         directions_renderer.setOptions({preserveViewport:true});

         camera_pin = new google.maps.Marker({
            position: start_point,
            map: map
         });

         start_pin = new google.maps.Marker({
            position: start_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (start_pin, 'dragend', function (event) {
            snapToRoad(start_pin.getPosition(), function(result) {
               start_pin.setPosition(result);
               hyperlapse.start = result;
               changeHash();
            });
         });

         end_pin = new google.maps.Marker({
            position: end_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (end_pin, 'dragend', function (event) {
            snapToRoad(end_pin.getPosition(), function(result) {
               end_pin.setPosition(result);
               hyperlapse.end = result;
               changeHash();
            });
         });

         pivot_pin = new google.maps.Marker({
            position: lookat_point,
            draggable: true,
            map: map
         });

         google.maps.event.addListener (pivot_pin, 'dragend', function (event) {
            hyperlapse.setLookat( pivot_pin.getPosition() );
            changeHash();
         });

         function findAddress(address) {
            geocoder.geocode( { 'address': address}, function(results, status) {
               if (status == google.maps.GeocoderStatus.OK) {
                  map.setCenter(results[0].geometry.location);
                  hyperlapse.drop_pins();
               } else {
                  show( "Geocode was not successful for the following reason: " + status );
               }
            });
         }

         var search = document.getElementById( 'searchButton' );
         search.addEventListener( 'click', function( event ) {
            event.preventDefault();
            findAddress( document.getElementById("address").value );
         }, false );


         /* Hyperlapse */

         var pano = document.getElementById('pano');
         var is_moving = false;
         var onPointerDownPointerX, onPointerDownPointerY, onPointerDownLon, onPointerDownLat;

         var hyperlapse = new Hyperlapse(pano, map, {
            start: start_point, 
            end: end_point,
            lookat: lookat_point,
            fov: 80,
            millis: 50,
            width: window.innerWidth,
            height: window.innerHeight,
            zoom: 3,
            distance_between_points: 100,
            max_points: 80,
            elevation: _elevation
         });
         
         hyperlapse.drop_pins = function(){
            var bounds = map.getBounds();
            var top_left = bounds.getNorthEast();
            var bot_right = bounds.getSouthWest();
            var hdif = Math.abs(top_left.lng() - bot_right.lng());
            var spacing = hdif/4;

            var center = map.getCenter();
            var c1 = new google.maps.LatLng(center.lat(), center.lng()-spacing);
            var c2 = new google.maps.LatLng(center.lat(), center.lng());
            var c3 = new google.maps.LatLng(center.lat(), center.lng()+spacing);

            hyperlapse.lookat = c2;
            pivot_pin.setPosition(c2);

            snapToRoad(c1, function(result1) {
               start_pin.setPosition(result1);
               hyperlapse.start = result1;

               snapToRoad(c3, function(result3) {
                  end_pin.setPosition(result3);
                  hyperlapse.end = result3;
                  changeHash();
               });
            });
         };

         hyperlapse.onRoute = function(e) {
            directions_renderer.setDirections(e.response);
            show( "Number of Points: "+ hyperlapse.length() );

            var marker;
            while(_route_markers.length > 0) {
               marker = _route_markers.pop();
               marker.setMap(null);
            }

            for(var i=0; i<e.points.length; i++) {
               _route_markers.push( new google.maps.Marker({
                  position: e.points[i],
                  draggable: false,
                  icon: "dot_marker.png",
                  map: map
                  })
               );
            }
         };

         hyperlapse.onLoadProgress = function(e) {
            show( "Loading: "+ (e.position+1) +" of "+ hyperlapse.length() );
         };

         hyperlapse.onError = function(e) {
            show( "ERROR: "+ e.message );
         };

         hyperlapse.onLoadComplete = function(e) {
            show( "" +
               "Start: " + start_pin.getPosition().toString() + 
               "<br>End: " + end_pin.getPosition().toString() + 
               "<br>Lookat: " + pivot_pin.getPosition().toString() + 
               "<br>Ready." );
         };

         hyperlapse.onFrame = function(e) {
            show( "" +
               "Start: " + start_pin.getPosition().toString() + 
               "<br>End: " + end_pin.getPosition().toString() + 
               "<br>Lookat: " + pivot_pin.getPosition().toString() + 
               "<br>Position: "+ (e.position+1) +" of "+ hyperlapse.length() );
            camera_pin.setPosition(e.point);
         };

         pano.addEventListener( 'mousedown', function(e){
            e.preventDefault();

            is_moving = true;

            onPointerDownPointerX = e.clientX;
            onPointerDownPointerY = e.clientY;

            onPointerDownLon = hyperlapse.getCameraPosition().lon;
            onPointerDownLat = hyperlapse.getCameraPosition().lat;
         }, false );

         pano.addEventListener( 'mousemove', function(e){
            e.preventDefault();
            var f = hyperlapse.fov() / 500;

            if ( is_moving ) {
               var dx = ( onPointerDownPointerX - e.clientX ) * f;
               var dy = ( e.clientY - onPointerDownPointerY ) * f;
               hyperlapse.position.x = dx + onPointerDownLon; // reversed dragging direction (thanks @mrdoob!)
               hyperlapse.position.y = dy + onPointerDownLat;
            }

         }, false );

         pano.addEventListener( 'mouseup', function(){
            is_moving = false;
         }, false );

         

         /* Dat GUI */

         var gui = new dat.GUI();

         var o = {
            distance_between_points:10, 
            max_points:100, 
            fov: 80, 
            elevation:Math.floor(_elevation), 
            tilt:0, 
            millis:50, 
            lookat:true,
            screen_width: window.innerWidth,
            screen_height: window.innerHeight,
            generate:function(){
               hyperlapse.reset();
               hyperlapse.generate();
            },
            save:function() {
               //window.open( hyperlapse.webgl().domElement.toDataURL( 'image/png' ), 'screenshot' );

               var dataURL = hyperlapse.webgl().domElement.toDataURL("image/png");
               dataURL = dataURL.replace("image/png", "image/octet-stream");
               document.location.href = dataURL;
            }
         };


         var scn = gui.addFolder('screen');
         scn.add(o, 'screen_width', window.innerHeight).listen();
         scn.add(o, 'screen_height', window.innerHeight).listen();
         scn.add(o, 'save');

         var parameters = gui.addFolder('parameters');

         var distance_between_points_control = parameters.add(o, 'distance_between_points', 5, 100);
         distance_between_points_control.onChange(function(value) {
            hyperlapse.setDistanceBetweenPoint(value);
         });

         var max_points = parameters.add(o, 'max_points', 10, 300);
         max_points.onChange(function(value) {
            hyperlapse.setMaxPoints(value);
         });

         var fov_control = parameters.add(o, 'fov', 1, 180);
         fov_control.onChange(function(value) {
            hyperlapse.setFOV(value);
         });

         var pitch_control = parameters.add(o, 'elevation', -1000, 1000);
         pitch_control.onChange(function(value) {
            _elevation = value;
            hyperlapse.elevation_offset = value;
            changeHash();
         });

         var tilt_control = parameters.add(o, 'tilt', -Math.PI/2, Math.PI/2);
         tilt_control.onChange(function(value) {
            hyperlapse.tilt = value;
         });

         var millis_control = parameters.add(o, 'millis', 10, 250);
         millis_control.onChange(function(value) {
            hyperlapse.millis = value;
         });

         var lookat_control = parameters.add(o, 'lookat');
         lookat_control.onChange(function(value) {
            if(value) {
               hyperlapse.enableLookat();
            } else {
               hyperlapse.disableLookat();
            }
         });

         

         var play_controls = gui.addFolder('play controls');
         play_controls.add(hyperlapse, 'play');
         play_controls.add(hyperlapse, 'pause');
         play_controls.add(hyperlapse, 'next');
         play_controls.add(hyperlapse, 'prev');

         gui.add(hyperlapse, 'drop_pins');
         gui.add(o, 'generate');
         gui.add(hyperlapse, 'load');


         window.addEventListener('resize', function(){
            hyperlapse.setSize(window.innerWidth, window.innerHeight);
            o.screen_width = window.innerWidth;
            o.screen_height = window.innerHeight;
         }, false);


         hyperlapse.generate();
      }

      window.onload = init;
   </script> 
</head> 
<body> 
   <div id="pano" style="position: absolute; left: 0; top: 0; right: 0; bottom: 0; z-index:-1;"></div>
   <div id="controls">
      <div id="map" style="width: 400px; height: 300px; float: left; padding: 0;"></div>
      <div id="controls" style="">
         <form id="map_form">
            <input type="text" name="address" id="address" />
            <button type="submit" id="searchButton" >Search</button>
         </form>
      </div>
      <div id="text" style="width: 500px; height: 120px; float: left; padding-top: 10px; z-index:0; border-style:solid; border-width:medium;"></div>
   </div>
   
   
</body> 
</html>